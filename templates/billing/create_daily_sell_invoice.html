{% extends "layout.html" %}
{% load static %}

{% block title %}Create Invoice{% endblock title %}

{% block content %}
<div class="max-w-7xl mx-auto p-6">
  <h1 class="text-3xl font-extrabold mb-6 text-primary">Create Daily Sell Invoice</h1>

  <form method="post" id="invoiceForm" class="space-y-6 bg-base-200 p-6 rounded-2xl shadow-lg">
    {% csrf_token %}

    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">

      <!-- Employees -->
      <div class="col-span-1" x-data="employeeSelect()">
        <label class="label"><span class="label-text font-medium">Employees (max 5)</span></label>
        <div class="relative">
          <button type="button" @click="open = !open" class="btn btn-outline w-full justify-between">
            <span x-text="selectedNames.length ? selectedNames.join(', ') : 'Select Employees'"></span>
            <i class="fa-solid fa-chevron-down ml-2"></i>
          </button>
          <div x-show="open" @click.outside="open=false" class="absolute z-50 w-full mt-1 bg-base-100 border rounded-lg shadow-lg p-2 max-h-60 overflow-y-auto">
            {% for emp in employees %}
              <label class="flex items-center gap-2 px-2 py-1 hover:bg-base-200 rounded cursor-pointer">
                <input type="checkbox" value="{{ emp.id }}" x-model="selected" @change="updateSelected"
                       class="checkbox checkbox-sm checkbox-primary">
                <span>{{ emp.name }}</span>
              </label>
            {% endfor %}
          </div>
        </div>
        <template x-for="id in selected" :key="id">
          <input type="hidden" name="employee_ids" :value="id">
        </template>
        <p x-show="tooMany" class="text-sm text-red-500 mt-2">You can select up to 5 employees only.</p>
      </div>

      <!-- Invoice Date & Payment Mode -->
      <div>
        <label class="label"><span class="label-text font-medium">Invoice Date</span></label>
        <input type="date" name="invoice_date" class="input input-bordered w-full"
               value="{{ today|date:'Y-m-d' }}" readonly>

        <label class="label mt-3"><span class="label-text font-medium">Payment Mode</span></label>
        <div class="flex gap-2 items-center">
          <label class="cursor-pointer"><input type="radio" name="payment_mode" value="Cash" checked class="radio radio-primary"><span class="ml-2">Cash</span></label>
          <label class="cursor-pointer"><input type="radio" name="payment_mode" value="Mixed" class="radio radio-accent"><span class="ml-2">Mixed</span></label>
          <label class="cursor-pointer"><input type="radio" name="payment_mode" value="AC" class="radio radio-secondary"><span class="ml-2">A/C</span></label>
        </div>
      </div>
    </div>

    <!-- Invoice Line Items -->
    <div class="bg-base-100 p-4 rounded-xl border mt-6">
      <div class="flex justify-between items-center mb-3">
        <h3 class="text-xl font-semibold">Invoice Items</h3>
        <button id="addRowBtn" type="button" class="btn btn-sm btn-outline">+ Add Item</button>
      </div>
      <div class="overflow-x-auto">
        <table class="table w-full">
          <thead>
            <tr>
              <th>#</th>
              <th>Subdealer (code)</th>
              <th>Product</th>
              <th>Qty</th>
              <th>Submitted Blanks</th>
              <th>Discounted Price (â‚¹)</th>
              <th>Line Total (â‚¹)</th>
              <th>Due Cyl</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="itemsTbody"></tbody>
        </table>
      </div>
    </div>

    <!-- Expenses -->
    <div class="bg-base-200 p-6 rounded-xl shadow-md mt-6" x-data="expenseHandler()">
      <h3 class="text-lg font-semibold mb-4 text-primary">Expenses</h3>
      <template x-for="(expense,index) in expenses" :key="index">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end mb-3">
          <div class="form-control">
            <label class="label"><span class="label-text font-medium">Expense Type</span></label>
            <select :name="'expense_type_'+index" class="select select-bordered w-full" x-model="expense.type" @change="updateAmount(expense)">
              <option value="">-- Select --</option>
              <template x-for="(amt,name) in predefinedExpenses" :key="name">
                <option :value="name" x-text="name+' - â‚¹'+amt"></option>
              </template>
              <option value="other">Other</option>
            </select>
          </div>
          <div class="form-control" x-show="expense.type==='other'">
            <label class="label"><span class="label-text font-medium">Description</span></label>
            <input type="text" :name="'expense_desc_'+index" x-model="expense.description" placeholder="Expense Description" class="input input-bordered w-full">
          </div>
          <div class="form-control">
            <label class="label"><span class="label-text font-medium">Amount</span></label>
            <input type="number" step="0.01" :name="'expense_amount_'+index" 
                   x-model.number="expense.amount"
                   :readonly="expense.type!=='other'"
                   @input="updateManual(expense)"
                   class="input input-bordered w-full">
          </div>
          <div class="col-span-3 text-right mt-1">
            <button type="button" class="btn btn-sm btn-error" @click="removeExpense(index)">Remove</button>
          </div>
        </div>
      </template>
      <button type="button" class="btn btn-sm btn-outline mt-2" @click="addExpense()">+ Add Expense</button>
    </div>

    <!-- Totals -->
    <div class="flex flex-col md:flex-row gap-4 justify-end items-end mt-6">
      <div class="bg-base-100 p-4 rounded-xl w-full md:w-1/3 shadow-sm">
        <div class="flex justify-between"><span>Total Quantity</span><span id="totalQty" class="font-semibold">0</span></div>
        <div class="flex justify-between mt-2"><span>Subtotal</span><span id="subTotal" class="font-semibold">â‚¹0.00</span></div>
        <div class="flex justify-between mt-2"><span>Other Expenses</span><span id="totalOtherExpense" class="font-semibold">â‚¹0.00</span></div>
        <hr class="my-3">
        <div class="flex justify-between"><span class="text-lg font-bold">Grand Total</span><span id="grandTotal" class="text-lg font-bold">â‚¹0.00</span></div>
      </div>
      <div class="w-full md:w-56">
        <label class="label"><span class="label-text font-medium">Notes</span></label>
        <textarea name="notes" class="textarea textarea-bordered w-full" rows="3" placeholder="Optional notes..."></textarea>
        <button type="submit" class="btn btn-primary mt-4 w-full">Save Invoice</button>
      </div>
    </div>
  </form>
</div>

<!-- Hidden Template Row -->
<table class="hidden">
  <tbody>
    <tr id="templateRow" class="align-top">
      <td class="row-index">1</td>
      <td>
        <select name="subdealer_code[]" class="select select-bordered w-48 subdealer-select" required>
          <option value="">Select Subdealer</option>
          {% for sd in subdealers %}
            <option value="{{ sd.subdealerCode }}">{{ sd.name }} ({{ sd.subdealerCode }})</option>
          {% endfor %}
        </select>
      </td>
      <td>
        <select name="product_id[]" class="select select-bordered product-select" required>
          <option value="">Select Product</option>
          {% for p in products %}
            <option value="{{ p.id }}" data-price="{{ p.product_price }}">{{ p.product_name }} â€” â‚¹{{ p.product_price }}</option>
          {% endfor %}
        </select>
      </td>
      <td><input type="number" name="quantity[]" class="input input-bordered qty-input w-24" min="1" value="1" required></td>
      <td><input type="number" name="submitted_blank[]" class="input input-bordered submit-input w-24" min="0" value="0"></td>
      <td><input type="text" name="discounted_price[]" class="input input-ghost discounted-input w-28" readonly></td>
      <td><input type="text" name="line_total[]" class="input input-ghost line-total-input w-28" readonly></td>
      <td><input type="text" name="due_cyl[]" class="input input-ghost due-input w-20" readonly></td>
      <td class="text-right"><button type="button" class="btn btn-sm btn-error remove-row-btn">Remove</button></td>
    </tr>
  </tbody>
</table>

<script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
<script>
const discountsMap = {{ discounts_map_json|safe }};

document.addEventListener('alpine:init', () => {

  // ðŸŒŸ Global store to sync expense totals
  Alpine.store('expense', {
    total: 0,
    updateTotal(amount) {
      this.total = amount;
      updateTotals();
    }
  });

  Alpine.data('employeeSelect', ()=>({
    open:false, selected:[], tooMany:false,
    get selectedNames(){
      return Array.from(document.querySelectorAll('[x-data="employeeSelect()"] input[type=checkbox]'))
                  .filter(ch=>this.selected.includes(ch.value))
                  .map(ch=>ch.nextElementSibling.textContent.trim());
    },
    updateSelected(){
      if(this.selected.length>5){ this.selected.pop(); this.tooMany=true; setTimeout(()=>this.tooMany=false,2500);}
      this.$nextTick(()=>{ document.dispatchEvent(new Event('employeeChange')); });
    }
  }));

  Alpine.data('expenseHandler', ()=>({
    predefinedExpenses: {{ predefined_expenses_json|safe }},
    selectedEmployeesCount:0,
    expenses:[],
    init(){
      document.addEventListener('employeeChange', ()=> {
        this.selectedEmployeesCount = document.querySelectorAll('[x-data="employeeSelect()"] input[type=checkbox]:checked').length;
        this.expenses.forEach(e=>this.updateAmount(e));
      });
    },
    addExpense(){ 
      this.expenses.push({type:'', description:'', amount:0}); 
      Alpine.store('expense').updateTotal(this.totalExpenses());
    },
    removeExpense(i){ 
      this.expenses.splice(i,1); 
      Alpine.store('expense').updateTotal(this.totalExpenses());
    },
    updateAmount(exp){
      if(exp.type && exp.type!=='other'){ 
        exp.amount = (parseFloat(this.predefinedExpenses[exp.type]||0)) * (this.selectedEmployeesCount||1);
      }
      Alpine.store('expense').updateTotal(this.totalExpenses());
    },
    updateManual(exp){
      Alpine.store('expense').updateTotal(this.totalExpenses());
    },
    totalExpenses(){ 
      return this.expenses.reduce((sum,e)=>sum+parseFloat(e.amount||0),0);
    }
  }));
});

// Line Items + Totals
const itemsTbody = document.getElementById('itemsTbody');
const templateRow = document.getElementById('templateRow');
document.getElementById('addRowBtn').addEventListener('click', addRow);

function addRow(){
  const clone = templateRow.cloneNode(true); clone.removeAttribute('id'); clone.classList.remove('hidden');
  clone.querySelectorAll('input, select').forEach(el=>{
    el.addEventListener('input', updateTotals);
    el.addEventListener('change', updateTotals);
  });
  clone.querySelector('.remove-row-btn').addEventListener('click', ()=>{ clone.remove(); updateTotals(); });
  itemsTbody.appendChild(clone);
  updateTotals();
}

function updateTotals(){
  let totalQty=0, subTotal=0;
  document.querySelectorAll('#itemsTbody tr').forEach(row=>{
    const qty = parseFloat(row.querySelector('.qty-input')?.value||0);
    const submitted = parseFloat(row.querySelector('.submit-input')?.value||0);
    const subdealer = row.querySelector('.subdealer-select')?.value;
    const product = row.querySelector('.product-select')?.value;
    const price = parseFloat(row.querySelector('.product-select')?.selectedOptions[0]?.dataset.price||0);

    let discount = 0;
    if(subdealer && product && discountsMap[subdealer] && discountsMap[subdealer][product]){
      discount = parseFloat(discountsMap[subdealer][product]);
    }
    const discountedPrice = Math.max(price - discount,0);
    const lineTotal = discountedPrice * qty;
    const dueCyl = Math.max(qty - submitted,0);

    row.querySelector('.discounted-input').value = discountedPrice.toFixed(2);
    row.querySelector('.line-total-input').value = lineTotal.toFixed(2);
    row.querySelector('.due-input').value = dueCyl;

    totalQty += qty; subTotal += lineTotal;
  });

  const otherExp = Alpine.store('expense')?.total || 0;

  document.getElementById('totalQty').textContent = totalQty;
  document.getElementById('subTotal').textContent = 'â‚¹'+subTotal.toFixed(2);
  document.getElementById('totalOtherExpense').textContent = '- â‚¹'+otherExp.toFixed(2);
  document.getElementById('grandTotal').textContent = 'â‚¹'+(subTotal - otherExp).toFixed(2);
}
</script>
{% endblock content %}
